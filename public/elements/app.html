<!DOCTYPE html>

<html>

<head>
    <meta name="csrf-token" content="<?php echo csrf_token() ?>" />
    <link href="../bower_components/polymer/polymer.html" rel="import">
    <link href="../bower_components/paper-drawer-panel/paper-drawer-panel.html" rel="import">
    <link href="../bower_components/paper-header-panel/paper-header-panel.html" rel="import">
    <link href="../bower_components/paper-toolbar/paper-toolbar.html" rel="import">
    <link href="../bower_components/paper-icon-button/paper-icon-button.html" rel="import">
    <link href="../bower_components/paper-fab/paper-fab.html" rel="import">
    <link href="../bower_components/paper-material/paper-material.html" rel="import">
    <link href="../bower_components/paper-menu/paper-menu.html" rel="import">    
    <link href="../bower_components/paper-item/paper-item.html" rel="import">
    <link href="../bower_components/paper-input/paper-input.html" rel="import">
    <link href="../bower_components/paper-button/paper-button.html" rel="import">
    <link href="../bower_components/paper-dialog/paper-dialog.html" rel="import">
    <link href="../bower_components/paper-dialog-behavior/paper-dialog-behavior.html" rel="import">
    <link href="../bower_components/neon-animation/animations/scale-up-animation.html" rel="import">
    <link href="../bower_components/neon-animation/animations/fade-out-animation.html" rel="import">   
    <link href="../bower_components/iron-overlay-behavior/iron-overlay-behavior.html" rel="import">
    <link href="../bower_components/iron-overlay-behavior/iron-overlay-backdrop.html" rel="import">
    <link href="../bower_components/iron-icons/iron-icons.html" rel="import">
    <link href="../bower_components/google-signin/google-signin.html" rel="import">
    <link href="../bower_components/platinum-https-redirect/platinum-https-redirect.html" rel="import">
    <script src="../js/jquery-2.1.4.min.js"> </script>
    <script src="../js/d3.v3.min.js"> </script>
    <script src="../js/graph.js"> </script>
    <script src="../js/index.js"> </script>
</head>

<dom-module id="base-app">
    
    <!-- Attempts to require the page to use HTTPS -->
    <platinum-https-redirect></platinum-https-redirect>

    <template>
        
        <paper-dialog 
            id="welcomeModal" 
            entry-animation="scale-up-animation" 
            exit-animation="fade-out-animation" 

            autoFitOnAttach="true"
            modal="true"
            withBackdrop="true">
            
            <div id="welcomeModalContent">
            
                <h2>Please Sign In</h2>
                <div>
                    <google-signin client-id="132101877152-mj6pbmmc8jt05q7o78sm39103fm00189.apps.googleusercontent.com" scopes="https://www.googleapis.com/auth/drive"></google-signin>
                </div>
            </div>
            
        </paper-dialog>
    
        <paper-drawer-panel>
        
            <paper-header-panel class="side-panel" drawer>
            
                <paper-toolbar>
                    <paper-item class="toolbarTitle">Exercises</paper-item>
                </paper-toolbar>
                
                <paper-menu id="menu">
                    <template is="dom-if" if="{{!menuButtons.length}}">
                        <paper-material>
                            <paper-item class="message" elevation="2">
                                <div class="centered">Please sign in!</div>
                            </paper-item>
                        </paper-material>
                    </template>
                    <template id="menuButtons" is="dom-repeat" items="{{menuButtons}}">
                        <paper-button id="menu-{{item.name}}" class="menuButton" on-tap="updateContentView" raised>{{item.name}}</paper-button>
                    </template>
                </paper-menu>
                
            </paper-header-panel>
            
            <paper-header-panel main class="main-panel">
            
                <paper-toolbar>
                
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    
                    <template id="userHeaderMessageTemplateDefault" is="dom-if" if="{{!currentUserFirstName.length}}">
                        <paper-item class="toolbarTitle">Your Training Log</paper-item>
                    </template>
                    <template id="userHeaderMessageTemplateFilled" is="dom-if" if="{{currentUserFirstName.length}}">
                        <paper-item class="toolbarTitle">{{currentUserFirstName}}'s Training Log</paper-item>
                    </template>
                    
                    <div id="left">
                        <google-signin client-id="132101877152-mj6pbmmc8jt05q7o78sm39103fm00189.apps.googleusercontent.com" scopes="https://www.googleapis.com/auth/drive" title="Sign out of your traing log?"></google-signin>
                    </div>

                </paper-toolbar>
                
                <div id="logWrapper">
                    <paper-material id="logSession" elevation="2">
                        <paper-input id="enterSets" label="Sets" maxlength="3"></paper-input>
                        <paper-input id="enterReps" label="Reps" maxlength="3"></paper-input>
                        <paper-input id="enterNotes" char-counter label="Notes" maxlength="140"></paper-input>
                        <paper-fab id="saveSession" class="buttonHover" icon="icons:done" on-tap="logExercise" title="Save this session?"></paper-fab>
                    </paper-material>
                </div>
                
                <div id="entryWrapper">
                    <paper-material>
                        <paper-item id="graphData" elevation="2">No notes to show!</paper-item>
                    </paper-material>
                </div>    
                    
                <div id="graphWrapper">
                    <div id="graph"> </div>
                    <paper-fab id="resetGraph" class="buttonHover" icon="icons:autorenew" title="Reset the graph to its original view?"></paper-fab>
                </div>
                
            </paper-header-panel>
            
        </paper-drawer-panel>

    </template>
    
</dom-module>

<script>

Polymer({
    is: "base-app",
    properties: {
        currentUser: String,
        currentUserFirstName: {
            type: String,
            value: "Your training log",
            reflect: true
        },
        menuButtons: {
            type: Array,
            value: [],
            reflect: true
        },
        graphData: {
            type: Array,
            value: [],
            reflect: true
        }
    },
    logExercise: function(e) {

        // Reference the local instance of the Polymer model for use inside the AJAX success callback
        var model = this;
        
        // Set up the CSRF token.
        $.ajaxSetup({ headers: { "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content") } });
    
        // Extract the POST data and reset the input
        var data = {
            name: $("#enterNotes").val()
        }
        $("#enterNotes").val('');
        
        // POST handling routine.
        $.ajax({
            type: "POST",
            url: "/record/exercise/create",
            data: data,
            success: function(response) {
                console.log("\nResponse:", response);
                $("#textArea").text(JSON.stringify(response));
                if (response.exercises) {
                    model.updateMenuButtons(response.exercises);
                }
                /*if (response.text) {
                    showSuccessMessage(response.text);
                } else {
                    showErrorMessage();
                }*/
            },
            error: function(error) {
                console.log("\nError:", error);
                $("#graphWrapper").html(error.responseText);
                // showErrorMessage();
            }
        });
    },
    setMenuButtons: function(e) {
        
        // Reference the local instance of the Polymer model for use inside the AJAX success callback
        var model = this;
        
        // Set up the CSRF token.
        $.ajaxSetup({ headers: { "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content") } });
    
        // POST handling routine.
        $.ajax({
            type: "POST",
            url: "/record/exercise/read",
            data: { name: "all" },
            success: function(response) {
                console.log("\nResponse:", response);
                $("#textArea").text(JSON.stringify(response));
                /*if (response.text) {
                    showSuccessMessage(response.text);
                } else {
                    showErrorMessage();
                }*/
                if (response.found) {
                    model.updateMenuButtons(response.found);
                }
            },
            error: function(error) {
                console.log("\nError:", error);
                $("#graphWrapper").html(error.responseText);
                // showErrorMessage();
            }
        });
    },
    updateMenuButtons: function(data) {
        this.menuButtons = data.sort(this.sortByProperty("name"));
    },
    updateContentView: function(e) {
        var button = e.target;
        var name = button.innerText; //button.getAttribute("data-exercise-name");
        console.log(name);
    },
    // From: https://stackoverflow.com/questions/1129216/sort-array-of-objects-by-string-property-value-in-javascript
    sortByProperty: function(property) {
        var sortOrder = 1;
        if(property[0] === "-") {
            sortOrder = -1;
            property = property.substr(1);
        }
        return function (a,b) {
            var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
            return result * sortOrder;
        }
    },
    signIn: function(e) {

        console.log("Signed In");
        
        // Extract the user details from the Google JWT sign in object
        var user = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
        var email = user.po;
        var firstName = user.Ph;
        console.log(user, email, firstName);
        
        this.currentUser = user.po;
        this.currentUserFirstName = user.Ph;
        
        this.handleUser(user.po, user.Ph);
    },
    handleUser: function(email, name) {
    
        // Reference the local instance of the Polymer model for use inside the AJAX success callback
        var model = this;

        // Set up the CSRF token.
        $.ajaxSetup({ headers: { "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content") } });
    
        // POST handling routine.
        $.ajax({
            type: "POST",
            url: "/email",
            data: { email: email },
            success: function(response) {
                console.log("\nResponse:", response);
                $("#textArea").text(JSON.stringify(response));
                /*if (response.text) {
                    showSuccessMessage(response.text);
                } else {
                    showErrorMessage();
                }*/
                if (response.user) {
                    model.closeWelcomeModal();
                }
            },
            error: function(error) {
                console.log("\nError:", error);
                $("#graphWrapper").html(error.responseText);
                // showErrorMessage();
            }
        });
    },
    signOut: function(e) {

        console.log("Signed Out");
        
        var user = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile(); console.log(user);
        this.clearModelProperties();
        
        
    },
    clearModelProperties: function() {
        this.currentUser = "";
        this.currentUserFirstName = "";
        this.menuButtons = [];
        this.graphData = [];
    },
    // From: https://scotch.io/tutorials/build-a-real-time-polymer-to-do-app
    findWithAttribute: function(array, attr, value) {
        for (var i = 0; i < array.length; i += 1) {
            if (array[i][attr] === value) { return i; }
        }
        return -1;
    },
    openWelcomeModal: function() {
        this.$.welcomeModal.open();
    },
    closeWelcomeModal: function() {
        this.$.welcomeModal.close();
        $(".iron-overlay-backdrop-0").hide();
        this.setMenuButtons();
    },
    drawGraph: function() {
        var data = {
    "list": [
        {   
            "id": "a",
            "date": "2014-1-01",
            "name": "Bench Press",
            "sets": "5",
            "reps": "5",
            "weight": "50",
            "notes": "AAA"
        },
        {
            "id": "b",
            "date": "2015-11-05",
            "name": "Bench Press",
            "sets": "5",
            "reps": "5",
            "weight": "225",
            "notes": "BBB"
        },
        {
            "id": "c",
            "date": "2016-5-09",
            "name": "Bench Press",
            "sets": "5",
            "reps": "5",
            "weight": "550",
            "notes": "CCC"
        }
    ]
};
        var graph = createGraph(data);
    },
    ready: function(e) {
        this.addEventListener('google-signin-success', this.signIn);
        this.addEventListener('google-signed-out', this.signOut);
        this.openWelcomeModal();
        this.drawGraph();
        
        var data = {
    "list": [
        {   
            "id": "200",
            "date": "2012-1-01",
            "name": "Bench Press",
            "sets": "5",
            "reps": "5",
            "weight": "50",
            "notes": "AAA"
        },
        {
            "id": "201",
            "date": "2013-7-05",
            "name": "Bench Press",
            "sets": "5",
            "reps": "5",
            "weight": "275",
            "notes": "BBB"
        },
        {
            "id": "202",
            "date": "2014-2-15",
            "name": "Bench Press",
            "sets": "1",
            "reps": "5",
            "weight": "275",
            "notes": "ccc"
        },
        {
            "id": "203",
            "date": "2017-5-09",
            "name": "Bench Press",
            "sets": "10",
            "reps": "5",
            "weight": "350",
            "notes": "ddd"
        }
    ]
};
        $("#entryWrapper").click(function() { updateGraph(data); });
    }
  });
</script>